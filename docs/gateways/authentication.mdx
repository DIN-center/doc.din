---
title: DIN Authentication
---

This section describes how a DIN Gateway would be added as an Ingress Operator for the router. We have mainly done this manually (as Infura was our only ingress operator in scope), but we are expanding the authentication protocol to include the additional handshake. The alpha testing for security purposes will likely remain manual (in collaboration with our dev team).

Figure 2: DIN Authentication

Is this a registered IP Address or domain that can ping the DIN Router? 
Answer: Yes. I believe this is a DNS (registered IP Address).
Is there a smart contract allow list or is it a manual handshake process for now? 
Answer: It would be a manual handshake for now, with the allowlist being stored in a configuration file until the smart contract registry is up and running.
How does Infura do this? 
Answer: Currently, Infura does not Authenticate to the DIN Router, but we are adding this functionality as we expand the services to more Web3 Gateways.

Configuration
In the initial implementation of the authentication protocol, the bare minimum configuration will require:
DIN Router
A Web3 EOA private key to sign requests
The existing configuration mapping services to provider endpoints
DIN Provider
A whitelist of Web3 Addresses to accept requests from
A secret key to create signed session tokens (this should be shared across all Caddy instances run by the same provider)
A configuration mapping services to backend endpoints (this will allow providers to run one set of DIN Provider Proxies for an arbitrary number of services).
Protocol
For each service / provider pairing, the DIN Router will establish a session.
The DIN Router will send an EIP-4361 authenticated message to the DIN Provider at https://$PROVIDER_ENDPOINT/auth. 
The Sign In With Ethereum message will have the form:

Message: $MESSAGE
$DOMAIN wants you to sign in with your Ethereum account:
$SIGNER_ADDRESS


URI: $PROVIDER_URL/auth
Version: 1
Chain ID: 1
Nonce: $NONCE
Issued At: $ISSUED_AT
Expiration Time: $EXPIRE_TIME
$MESSAGE: At this time, the contents of this field is not important. Within the Sign In With Ethereum protocol, this is intended to be shown to the user signing with a wallet. As these signatures will be automated, this field can be ignored, but will be included by Sign In With Ethereum libraries.
$DOMAIN: Domain should reflect the address of the router.
$SIGNER_ADDRESS: Should match the address used to sign this message.
$PROVIDER_URL: should match the public address of the provider verifying this message.
$NONCE: This is a random value specified by the signer to distinguish this request from others. 
$ISSUED_AT: An ISO-8601 Timestamp of when this message was created
$EXPIRE_TIME: An ISO-8601 Timestamp of when this message should no longer be accepted. Note that this is not the expiration of the token being requested, just for this request. It should generally be within a few minutes.
This message should be included in a JSON payload of the form:

```
{"msg": "Message: ... Expiration Time...", "sig": "0x12234...0abcd"}
```

Where “sig” should be the signature produced by signing the message with the private key associated with $SIGNER_ADDRESS.
The DIN Provider will verify the message, and confirm that the signer appears in its whitelist.
If the message does not verify or the signer is not in the whitelist, the DIN provider should respond with a 401 status code.
The DIN Provider will respond with:


```
{
	"headers": {"x-api-key": "$API_KEY"},
	"exp": $EXPIRATION_TIME,
	"uses": $USES_LIMIT,
	"error": $ERROR_MESSAGE
}
```

$API_KEY: The API key generated by the provider. The provided DIN caddy plugins will have a JWT token here, but from a protocol perspective it should be treated as an opaque key.
$EXPIRATION_TIME: A unix timestamp after which this key will no longer be accepted. Either this or “uses” should be specified, not both.
$USES_LIMIT: The number of times this key may be used. Either this or “exp” should be specified, not both.
$ERROR_MESSAGE: A message indicating why the other fields could not be provided.
For each request to the DIN Router
The DIN Router will select a provider that offers the service capable of handling the incoming request.
If there is a current API Key available for that service / provider pairing, the router will forward the RPC request to that provider including the API Key associated with the session in the x-api-key header.
If there is not a current API key for that service / provider pairing, the DIN Router should establish a session as defined above.
The DIN Provider will verify the API key in the x-api-key header, and ensure that it is associated with the appropriate service.
If the API key is not present, the provider should respond with a 401 status code
If the API key is present, but is expired or does not authorize access to the request service, the provider should respond with a 403 status code.
If the API key verifies successfully, the provider should proxy the request to the backend service and return the response.
